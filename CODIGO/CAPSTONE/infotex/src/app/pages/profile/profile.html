<div class="profile-page container py-4">
  <div class="row justify-content-center">
    <div class="col-xxl-9 col-lg-10">
      <div class="card bg-dark text-light border-secondary shadow">
        <div class="card-body p-4 p-lg-5">
          <div class="profile-header mb-4">
            <div>
              <h2 class="card-title h4 mb-1">Tu perfil</h2>
              <p class="mb-0 text-secondary">Revisa la información que has registrado.</p>
            </div>
            <div class="profile-header__actions">
              <button
                type="button"
                class="icon-button icon-button--ghost"
                (click)="retry()"
                [disabled]="loading()"
                aria-label="Actualizar información del perfil"
              >
                <span class="spinner-border spinner-border-sm" role="status" *ngIf="loading()"></span>
                <i class="bi bi-arrow-clockwise" *ngIf="!loading()"></i>
              </button>
            </div>
          </div>

          <div *ngIf="loading()" class="text-center py-5">
            <div class="spinner-border text-light" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 mb-0">Obteniendo la información de tu perfil...</p>
          </div>

          <div id="liveAlertPlaceholder" #alertPlaceholder></div>

          <ng-container *ngIf="!loading()">
            <ng-container *ngIf="!loadError()">
              <ng-container *ngIf="profile(); else noProfileData">
                <div class="profile-grid mt-4">
                  <section class="profile-section profile-section--overview">
                    <div class="profile-section__header">
                      <div>
                        <span class="profile-section__eyebrow">Resumen</span>
                        <h3 class="profile-section__title mb-0">Información general</h3>
                      </div>
                      <div class="profile-section__actions">
                        <button
                          type="button"
                          class="icon-button icon-button--primary"
                          (click)="openEditor()"
                          aria-label="Editar información general"
                        >
                          <i class="bi bi-pencil-square" width="40" height="40"></i>
                        </button>
                      </div>
                    </div>

                    <div class="profile-section__body">
                      <div class="d-flex flex-column flex-lg-row align-items-start gap-4">
                        <div class="profile-avatar-wrapper">
                          <ng-container *ngIf="profile()?.avatarUrl && !avatarHasError(); else avatarPlaceholder">
                            <img
                              [src]="profile()?.avatarUrl ?? ''"
                              alt="Foto de perfil"
                              class="profile-avatar-img"
                              (error)="handleAvatarError()"
                            />
                          </ng-container>
                          <ng-template #avatarPlaceholder>
                            <div class="profile-avatar-placeholder">
                              <span>Sin foto</span>
                            </div>
                          </ng-template>
                        </div>

                        <div class="flex-grow-1 w-100">
                          <h3
                            class="h4 mb-1"
                            [class.text-white]="!!profile()?.displayName"
                            [class.text-secondary]="!profile()?.displayName"
                          >
                            {{ profile()?.displayName || 'Nombre no registrado' }}
                          </h3>
                          <p
                            class="mb-3"
                            [class.text-light]="!!profile()?.career"
                            [class.text-secondary]="!profile()?.career"
                          >
                            {{ profile()?.career || 'Carrera no registrada' }}
                          </p>

                          <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3 profile-details">
                            <div class="col">
                              <div class="profile-detail">
                                <span class="profile-detail-label">País</span>
                                <span class="profile-detail-value" [class.text-secondary]="!profile()?.country">
                                  {{ profile()?.country || 'Sin registrar' }}
                                </span>
                              </div>
                            </div>
                            <div class="col">
                              <div class="profile-detail">
                                <span class="profile-detail-label">Ciudad</span>
                                <span class="profile-detail-value" [class.text-secondary]="!profile()?.city">
                                  {{ profile()?.city || 'Sin registrar' }}
                                </span>
                              </div>
                            </div>
                            <div class="col">
                              <div class="profile-detail">
                                <span class="profile-detail-label">Carrera</span>
                                <span class="profile-detail-value" [class.text-secondary]="!profile()?.career">
                                  {{ profile()?.career || 'Sin registrar' }}
                                </span>
                              </div>
                            </div>
                            <div class="col">
                              <div class="profile-detail">
                                <span class="profile-detail-label">URL pública</span>
                                <span class="profile-detail-value" [class.text-secondary]="!profile()?.slug">
                                  <ng-container *ngIf="profile()?.slug as slug; else noSlug">
                                    infotex.com/perfil/{{ slug }}
                                  </ng-container>
                                </span>
                                <ng-template #noSlug>
                                  <span class="profile-detail-value text-secondary">Sin registrar</span>
                                </ng-template>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </section>

                  <section class="profile-section profile-section--biography">
                    <div class="profile-section__header">
                      <div>
                        <span class="profile-section__eyebrow">Historia</span>
                        <h3 class="profile-section__title mb-0">Biografía</h3>
                        <p class="profile-section__subtitle text-secondary mb-0">Comparte quién eres y tu experiencia.</p>
                      </div>
                      <div class="profile-section__actions">
                        <button
                          type="button"
                          class="icon-button icon-button--primary"
                          (click)="openEditor()"
                          aria-label="Editar biografía"
                        >
                          <i class="bi bi-pencil-square"></i>
                        </button>
                      </div>
                    </div>

                    <div class="profile-section__body">
                      <p class="mb-0" [class.text-secondary]="!profile()?.biography">
                        {{ profile()?.biography || 'Aún no has agregado una biografía.' }}
                      </p>
                    </div>
                  </section>

                  <section class="profile-section profile-section--education">
                    <div class="profile-section__header">
                      <div>
                        <span class="profile-section__eyebrow">Formación</span>
                        <h3 class="profile-section__title mb-1">Educación</h3>
                        <p class="profile-section__subtitle text-secondary mb-0">
                          <ng-container *ngIf="educationSummary() as summary; else educationSummaryFallback">
                            <ng-container *ngIf="summary.totalRecords > 0; else noEducationRecords">
                              {{ summary.totalRecords === 1 ? '1 registro educativo' : summary.totalRecords + ' registros educativos' }}.
                              <ng-container *ngIf="summary.invalidDateCount > 0">
                                {{ summary.invalidDateCount === 1 ? 'Un registro' : summary.invalidDateCount + ' registros' }} requiere revisar las fechas.
                              </ng-container>
                            </ng-container>
                            <ng-template #noEducationRecords>
                              Aún no has agregado tu educación.
                            </ng-template>
                          </ng-container>
                          <ng-template #educationSummaryFallback>
                            Aún no has agregado tu educación.
                          </ng-template>
                        </p>
                      </div>
                      <div class="profile-section__actions">
                        <button
                          type="button"
                          class="icon-button icon-button--primary"
                          (click)="openEducationCreator()"
                          aria-label="Agregar educación"
                        >
                          <i class="bi bi-pencil-square"></i>
                        </button>
                      </div>
                    </div>

                    <div class="profile-section__body">
                      <div *ngIf="educationError()" class="alert alert-danger" role="alert">
                        {{ educationError() }}
                      </div>

                      <div *ngIf="educationLoading()" class="text-secondary">
                        Cargando educación...
                      </div>

                      <ng-container *ngIf="!educationLoading() && !educationError()">
                        <div *ngIf="education().length > 0; else noEducationItems" class="education-list mt-3">
                          <div
                            class="education-item card bg-dark border-secondary mb-3"
                            *ngFor="let item of education(); trackBy: trackEducationById"
                          >
                            <div
                              class="education-item__body card-body d-flex flex-column flex-md-row justify-content-between align-items-start gap-3"
                            >
                              <div>
                                <h4 class="h6 mb-1 text-white">{{ item.institution }}</h4>
                                <p class="mb-1 text-secondary" *ngIf="item.degree || item.fieldOfStudy">
                                  <ng-container *ngIf="item.degree">{{ item.degree }}</ng-container>
                                  <ng-container *ngIf="item.degree && item.fieldOfStudy"> · </ng-container>
                                  <ng-container *ngIf="item.fieldOfStudy">{{ item.fieldOfStudy }}</ng-container>
                                </p>
                                <p class="mb-0 text-secondary small">
                                  {{ item.startDate | date:'yyyy' }} – {{ item.endDate | date:'yyyy' }}
                                </p>
                              </div>
                            </div>
                            <div class="education-item__description card-body pt-0">
                              <p class="mb-0 text-light" *ngIf="item.description; else noEducationDescription">
                                {{ item.description }}
                              </p>
                              <ng-template #noEducationDescription>
                                <p class="mb-0 text-secondary">Sin descripción adicional.</p>
                              </ng-template>
                            </div>
                          </div>
                        </div>
                        <ng-template #noEducationItems>
                          <p class="text-secondary mt-3 mb-0">Aún no has agregado tu educación.</p>
                        </ng-template>
                      </ng-container>
                    </div>
                  </section>

                  <section class="profile-section profile-section--experience">
                    <div class="profile-section__header">
                      <div>
                        <span class="profile-section__eyebrow">Trayectoria</span>
                        <h3 class="profile-section__title mb-1">Experiencia</h3>
                        <p class="profile-section__subtitle text-secondary mb-0">
                          <ng-container *ngIf="experienceSummary() as summary; else experienceSummaryFallback">
                            <ng-container *ngIf="summary.totalRecords > 0; else noExperienceRecords">
                              {{ summary.totalRecords === 1 ? '1 experiencia laboral' : summary.totalRecords + ' experiencias laborales' }}.
                              <ng-container *ngIf="summary.invalidDateCount > 0">
                                {{ summary.invalidDateCount === 1 ? 'Un registro requiere' : summary.invalidDateCount + ' registros requieren' }} revisar las fechas.
                              </ng-container>
                              <ng-container *ngIf="summary.currentCount > 0">
                                {{ summary.currentCount === 1 ? 'Actualmente 1 rol activo.' : 'Actualmente ' + summary.currentCount + ' roles activos.' }}
                              </ng-container>
                            </ng-container>
                            <ng-template #noExperienceRecords>
                              Aún no has agregado tu experiencia laboral.
                            </ng-template>
                          </ng-container>
                          <ng-template #experienceSummaryFallback>
                            Aún no has agregado tu experiencia laboral.
                          </ng-template>
                        </p>
                      </div>
                      <div class="profile-section__actions">
                        <button
                          type="button"
                          class="icon-button icon-button--primary"
                          (click)="openExperienceCreator()"
                          aria-label="Agregar experiencia"
                        >
                          <i class="bi bi-briefcase"></i>
                        </button>
                      </div>
                    </div>

                    <div class="profile-section__body">
                      <div *ngIf="experienceError()" class="alert alert-danger" role="alert">
                        {{ experienceError() }}
                      </div>

                      <div *ngIf="experienceLoading()" class="text-secondary">
                        Cargando experiencia...
                      </div>

                      <ng-container *ngIf="!experienceLoading() && !experienceError()">
                        <div *ngIf="experience().length > 0; else noExperienceItems" class="experience-list mt-3">
                          <div
                            class="experience-item card bg-dark border-secondary mb-3"
                            *ngFor="let item of experience(); trackBy: trackExperienceById"
                          >
                            <div
                              class="experience-item__body card-body d-flex flex-column flex-md-row justify-content-between align-items-start gap-3"
                            >
                              <div>
                                <h4 class="h6 mb-1 text-white">{{ item.title }}</h4>
                                <p class="mb-1 text-secondary" *ngIf="item.company || item.location">
                                  <ng-container *ngIf="item.company">{{ item.company }}</ng-container>
                                  <ng-container *ngIf="item.company && item.location"> · </ng-container>
                                  <ng-container *ngIf="item.location">{{ item.location }}</ng-container>
                                </p>
                                <p class="mb-0 text-secondary small">
                                  {{ item.startDate | date:'yyyy' }} –
                                  <ng-container *ngIf="item.endDate; else currentExperience">{{ item.endDate | date:'yyyy' }}</ng-container>
                                </p>
                                <ng-template #currentExperience>Presente</ng-template>
                              </div>
                            </div>
                            <div class="experience-item__description card-body pt-0">
                              <p class="mb-0 text-light" *ngIf="item.description; else noExperienceDescription">
                                {{ item.description }}
                              </p>
                              <ng-template #noExperienceDescription>
                                <p class="mb-0 text-secondary">Sin descripción adicional.</p>
                              </ng-template>
                            </div>
                          </div>
                        </div>
                        <ng-template #noExperienceItems>
                          <p class="text-secondary mt-3 mb-0">Aún no has agregado tu experiencia laboral.</p>
                        </ng-template>
                      </ng-container>
                    </div>
                  </section>

                  <section class="profile-section profile-section--skills">
                    <div class="profile-section__header">
                      <div>
                        <span class="profile-section__eyebrow">Talento</span>
                        <h3 class="profile-section__title mb-1">Habilidades</h3>
                        <p class="profile-section__subtitle text-secondary mb-0">
                          <ng-container *ngIf="skillsSummary() as summary; else skillsSummaryFallback">
                            <ng-container *ngIf="summary.totalSkills > 0; else noSkillsRecords">
                              {{ summary.totalSkills === 1 ? '1 habilidad registrada' : summary.totalSkills + ' habilidades registradas' }}.
                              <ng-container *ngIf="summary.averageLevel !== null">
                                Nivel promedio {{ summary.averageLevel | number:'1.1-1' }} / 5.
                              </ng-container>
                              <ng-container *ngIf="summary.maxLevel !== null && summary.minLevel !== null">
                                Rango {{ summary.minLevel }}–{{ summary.maxLevel }}.
                              </ng-container>
                            </ng-container>
                            <ng-template #noSkillsRecords>
                              Aún no has agregado tus habilidades.
                            </ng-template>
                          </ng-container>
                          <ng-template #skillsSummaryFallback>
                            Aún no has agregado tus habilidades.
                          </ng-template>
                        </p>
                      </div>
                      <div class="profile-section__actions">
                        <button
                          type="button"
                          class="icon-button icon-button--primary"
                          (click)="openSkillCreator()"
                          aria-label="Agregar habilidad"
                          [disabled]="skillsSaving()"
                        >
                          <i class="bi bi-stars"></i>
                        </button>
                      </div>
                    </div>

                    <div class="profile-section__body">
                      <div *ngIf="skillsError()" class="alert alert-danger" role="alert">
                        {{ skillsError() }}
                      </div>

                      <div *ngIf="skillsLoading()" class="text-secondary">
                        Cargando habilidades...
                      </div>

                      <ng-container *ngIf="!skillsLoading() && !skillsError()">
                        <div *ngIf="skills().length > 0; else noSkillItems" class="skills-list mt-3">
                          <div
                            class="skill-item card bg-dark border-secondary mb-3"
                            *ngFor="let item of skills(); trackBy: trackSkillById"
                          >
                            <div class="skill-item__body card-body">
                              <div class="skill-item__header">
                                <div class="skill-item__info">
                                  <h4 class="h6 mb-1 text-white">{{ item.name }}</h4>
                                  <p class="mb-0 text-secondary" *ngIf="item.category">{{ item.category }}</p>
                                </div>
                                <div class="skill-item__stats">
                                  <div class="skill-stat">
                                    <span class="skill-stat__label">Nivel</span>
                                    <span class="skill-stat__value">{{ item.level !== null ? item.level : '—' }}</span>
                                  </div>
                                  <div class="skill-stat">
                                    <span class="skill-stat__label">Años</span>
                                    <span class="skill-stat__value">
                                      {{ item.yearsExperience !== null ? (item.yearsExperience | number:'1.0-1') : '—' }}
                                    </span>
                                  </div>
                                  <div class="skill-stat">
                                    <span class="skill-stat__label">Respaldos</span>
                                    <span class="skill-stat__value">{{ item.endorsementCount }}</span>
                                  </div>
                                </div>
                              </div>

                              <div class="skill-item__actions">
                                <button
                                  type="button"
                                  class="btn btn-outline-light btn-sm"
                                  (click)="editSkill(item)"
                                  [disabled]="skillsSaving() || skillsDeletingId() === item.skillId"
                                >
                                  <i class="bi bi-pencil me-1"></i>
                                  Editar
                                </button>
                                <button
                                  type="button"
                                  class="btn btn-outline-danger btn-sm"
                                  (click)="deleteSkill(item)"
                                  [disabled]="skillsDeletingId() === item.skillId || skillsSaving()"
                                >
                                  <span
                                    *ngIf="skillsDeletingId() === item.skillId"
                                    class="spinner-border spinner-border-sm me-2"
                                    role="status"
                                    aria-hidden="true"
                                  ></span>
                                  <ng-container *ngIf="skillsDeletingId() !== item.skillId">
                                    <i class="bi bi-trash me-1"></i>
                                  </ng-container>
                                  {{ skillsDeletingId() === item.skillId ? 'Eliminando...' : 'Eliminar' }}
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                        <ng-template #noSkillItems>
                          <p class="text-secondary mt-3 mb-0">Aún no has agregado tus habilidades.</p>
                        </ng-template>
                      </ng-container>
                    </div>
                  </section>
                </div>
              </ng-container>

              <ng-template #noProfileData>
                <div class="alert alert-info" role="alert">
                  Aún no hay información de perfil registrada. Selecciona «Editar perfil» para comenzar.
                </div>
              </ng-template>
            </ng-container>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-container *ngIf="editorOpen()">
  <div class="profile-editor" role="dialog" aria-modal="true" aria-labelledby="profileEditorTitle">
    <div class="profile-editor__backdrop" (click)="closeEditor()"></div>
    <div class="profile-editor__panel" (click)="$event.stopPropagation()">
      <div class="profile-editor__header d-flex justify-content-between align-items-start gap-3">
        <div>
          <h2 id="profileEditorTitle" class="h5 mb-1 text-white">Editar perfil</h2>
          <p class="mb-0 text-secondary">Actualiza y guarda tu información personal.</p>
        </div>
        <button type="button" class="btn-close btn-close-white" aria-label="Cerrar" (click)="closeEditor()"></button>
      </div>
      <div class="profile-editor__body">
        <div *ngIf="successMessage()" class="alert alert-success" role="alert">
          {{ successMessage() }}
        </div>
        <div *ngIf="submitError()" class="alert alert-danger" role="alert">
          {{ submitError() }}
        </div>

        <form class="profile-form" [formGroup]="profileForm" (ngSubmit)="save()" novalidate>
          <div class="mb-3">
            <label for="profileDisplayName" class="form-label">Nombre para mostrar</label>
            <input
              id="profileDisplayName"
              type="text"
              class="form-control"
              formControlName="displayName"
              [class.is-invalid]="
                (displayNameControl.invalid && (displayNameControl.dirty || displayNameControl.touched)) ||
                fieldState().displayName.ok === false
              "
            />
            <div class="invalid-feedback" *ngIf="displayNameControl.hasError('required') && (displayNameControl.dirty || displayNameControl.touched)">
              El nombre para mostrar es obligatorio.
            </div>
            <div class="invalid-feedback" *ngIf="fieldState().displayName.ok === false">
              {{ fieldState().displayName.error || 'El servidor reportó un problema con este campo.' }}
            </div>
          </div>

          <div class="mb-3">
            <label for="profileSlug" class="form-label">URL personalizada</label>
            <div class="input-group">
              <span class="input-group-text text-secondary">infotex.com/perfil/</span>
              <input
                id="profileSlug"
                type="text"
                class="form-control"
                formControlName="slug"
                autocomplete="off"
                [class.is-invalid]="
                  (slugControl.invalid && (slugControl.dirty || slugControl.touched)) ||
                  fieldState().slug.ok === false
                "
              />
            </div>
            <div class="form-text text-secondary">Usa solo minúsculas, números y guiones. Ej: mi-portafolio.</div>
            <div
              class="invalid-feedback"
              *ngIf="slugControl.hasError('required') && (slugControl.dirty || slugControl.touched)"
            >
              La URL personalizada es obligatoria.
            </div>
            <div
              class="invalid-feedback"
              *ngIf="slugControl.hasError('pattern') && (slugControl.dirty || slugControl.touched)"
            >
              Ingresa de 3 a 40 caracteres válidos (minúsculas, números y guiones).
            </div>
            <div class="invalid-feedback" *ngIf="fieldState().slug.ok === false">
              {{ fieldState().slug.error || 'El servidor reportó un problema con este campo.' }}
            </div>
          </div>

          <div class="mb-3">
            <label for="profileCareer" class="form-label">Carrera</label>
            <select
              id="profileCareer"
              class="form-select"
              formControlName="career"
              aria-label="Selecciona tu carrera"
              [class.is-invalid]="
                (careerControl.invalid && (careerControl.dirty || careerControl.touched)) ||
                fieldState().career.ok === false
              "
            >
              <option value="" disabled [selected]="!careerControl.value">Selecciona una carrera</option>
              <ng-container *ngFor="let group of careerCategoryOptions(); trackBy: trackCareerCategory">
                <optgroup [label]="group.name">
                  <option
                    *ngFor="let option of group.options; trackBy: trackCareerOption"
                    [value]="option"
                  >
                    {{ option }}
                  </option>
                </optgroup>
              </ng-container>
            </select>
            <div class="form-text text-light" *ngIf="careersLoading()">Cargando carreras...</div>
            <div class="form-text text-warning" *ngIf="careersError()">{{ careersError() }}</div>
            <div
              class="invalid-feedback"
              *ngIf="careerControl.hasError('required') && (careerControl.dirty || careerControl.touched)"
            >
              La carrera es obligatoria.
            </div>
            <div class="invalid-feedback" *ngIf="fieldState().career.ok === false">
              {{ fieldState().career.error || 'El servidor reportó un problema con este campo.' }}
            </div>
          </div>

          <div class="mb-3">
            <label for="profileBiography" class="form-label">Biografía</label>
            <textarea
              id="profileBiography"
              class="form-control"
              formControlName="biography"
              rows="4"
              [class.is-invalid]="
                (biographyControl.invalid && (biographyControl.dirty || biographyControl.touched)) ||
                fieldState().biography.ok === false
              "
            ></textarea>
            <div class="form-text text-light">Escribe al menos 80 caracteres sobre ti.</div>
            <div class="invalid-feedback" *ngIf="biographyControl.hasError('required') && (biographyControl.dirty || biographyControl.touched)">
              La biografía es obligatoria.
            </div>
            <div class="invalid-feedback" *ngIf="biographyControl.hasError('minTrimmedLength') && (biographyControl.dirty || biographyControl.touched)">
              La biografía debe contener al menos 80 caracteres.
            </div>
            <div class="invalid-feedback" *ngIf="fieldState().biography.ok === false">
              {{ fieldState().biography.error || 'El servidor reportó un problema con este campo.' }}
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6 col-lg-4">
              <div class="form-floating">
                <select
                  id="profileCountry"
                  class="form-select"
                  formControlName="country"
                  aria-label="Selecciona tu país"
                  [class.is-invalid]="
                    (countryControl.invalid && (countryControl.dirty || countryControl.touched)) ||
                    fieldState().country.ok === false
                  "
                >
                  <option [value]="defaultCountry">{{ defaultCountry }}</option>
                </select>
                <label for="profileCountry">País</label>
              </div>
              <div
                class="invalid-feedback"
                *ngIf="countryControl.hasError('required') && (countryControl.dirty || countryControl.touched)"
              >
                El país es obligatorio.
              </div>
              <div class="invalid-feedback" *ngIf="fieldState().country.ok === false">
                {{ fieldState().country.error || 'El servidor reportó un problema con este campo.' }}
              </div>
            </div>

            <div class="col-md-6 col-lg-4">
              <div class="form-floating">
                <select
                  id="profileCity"
                  class="form-select"
                  formControlName="city"
                  aria-label="Selecciona tu ciudad"
                  [class.is-invalid]="
                    (cityControl.invalid && (cityControl.dirty || cityControl.touched)) ||
                    fieldState().city.ok === false
                  "
                >
                  <option value="" disabled [selected]="!cityControl.value">Selecciona una ciudad</option>
                  <option
                    *ngFor="let option of cityOptions(); trackBy: trackCityOption"
                    [value]="option"
                  >
                    {{ option }}
                  </option>
                </select>
                <label for="profileCity">Ciudad</label>
              </div>
              <div class="form-text text-light" *ngIf="citiesLoading()">Cargando ciudades...</div>
              <div class="form-text text-warning" *ngIf="citiesError()">{{ citiesError() }}</div>
              <div
                class="invalid-feedback"
                *ngIf="cityControl.hasError('required') && (cityControl.dirty || cityControl.touched)"
              >
                La ciudad es obligatoria.
              </div>
              <div class="invalid-feedback" *ngIf="fieldState().city.ok === false">
                {{ fieldState().city.error || 'El servidor reportó un problema con este campo.' }}
              </div>
            </div>

          </div>

          <div class="mb-4 mt-3">
            <label for="profileAvatarUrl" class="form-label">URL de la foto de perfil</label>
            <input
              id="profileAvatarUrl"
              type="url"
              class="form-control"
              formControlName="avatarUrl"
              [class.is-invalid]="
                (avatarUrlControl.invalid && (avatarUrlControl.dirty || avatarUrlControl.touched)) ||
                fieldState().avatarUrl.ok === false
              "
            />
            <div class="invalid-feedback" *ngIf="avatarUrlControl.hasError('required') && (avatarUrlControl.dirty || avatarUrlControl.touched)">
              La URL de la foto de perfil es obligatoria.
            </div>
                        <div
              class="invalid-feedback"
              *ngIf="avatarUrlControl.hasError('invalidAvatarUrl') && (avatarUrlControl.dirty || avatarUrlControl.touched)"
            >
              Ingresa una URL válida (http/https) o una ruta que comience con <code>/</code>.
            </div>
            <div class="invalid-feedback" *ngIf="fieldState().avatarUrl.ok === false">
              {{ fieldState().avatarUrl.error || 'El servidor reportó un problema con este campo.' }}
            </div>
            <div class="mt-3">
              <span class="form-label d-block mb-2">O selecciona una imagen predeterminada</span>
              <button
                type="button"
                class="btn btn-outline-info avatar-selector-trigger"
                (click)="openAvatarSelector()"
                [disabled]="profileForm.disabled"
              >
                InfoTex Avatar
              </button>
              <div class="form-text text-light mt-2">
                Guarda tus imágenes en <code>public/avatars</code> y actualiza las rutas si es necesario.
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-light" (click)="closeEditor()" [disabled]="saving()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="profileForm.invalid || profileForm.disabled || saving()">
              <span class="spinner-border spinner-border-sm me-2" role="status" *ngIf="saving()"></span>
              Guardar cambios
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</ng-container>
<ng-container *ngIf="educationEditorOpen()">
  <div
    class="profile-editor"
    role="dialog"
    aria-modal="true"
    aria-labelledby="educationEditorTitle"
  >
    <div class="profile-editor__backdrop" (click)="cancelEducationEdit()"></div>
    <div class="profile-editor__panel" (click)="$event.stopPropagation()">
      <div class="profile-editor__header d-flex justify-content-between align-items-start gap-3">
        <div>
          <h2 id="educationEditorTitle" class="h5 mb-1 text-white">
            {{ editingEducationId() ? 'Editar educación' : 'Agregar educación' }}
          </h2>
          <p class="mb-0 text-secondary">
            Mantén actualizado tu historial académico para mostrar tu formación.
          </p>
        </div>
        <button
          type="button"
          class="btn-close btn-close-white"
          aria-label="Cerrar"
          (click)="cancelEducationEdit()"
          [disabled]="educationSaving()"
        ></button>
      </div>
      <div class="profile-editor__body">
        <div *ngIf="educationSubmitError()" class="alert alert-danger" role="alert">
          {{ educationSubmitError() }}
        </div>
        <form class="education-form" [formGroup]="educationForm" (ngSubmit)="saveEducation()" novalidate>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="educationInstitution" class="form-label">Institución</label>
              <input
                id="educationInstitution"
                type="text"
                class="form-control"
                formControlName="institution"
                [class.is-invalid]="
                  educationForm.controls.institution.invalid &&
                  (educationForm.controls.institution.dirty || educationForm.controls.institution.touched)
                "
              />
              <div class="invalid-feedback">La institución es obligatoria.</div>
            </div>
            <div class="col-md-6">
              <label for="educationDegree" class="form-label">Grado o certificación</label>
              <input id="educationDegree" type="text" class="form-control" formControlName="degree" />
            </div>
            <div class="col-md-6">
              <label for="educationField" class="form-label">Área de estudio</label>
              <input id="educationField" type="text" class="form-control" formControlName="fieldOfStudy" />
            </div>
<div class="col-md-3">
  <label for="educationStart" class="form-label">Año inicio</label>
  <select id="educationStart" class="form-control" formControlName="startDate">
    <option *ngFor="let year of years" [value]="year">{{ year }}</option>
  </select>
</div>

<div class="col-md-3">
  <label for="educationEnd" class="form-label">Año fin</label>
  <select id="educationEnd" class="form-control" formControlName="endDate">
    <option *ngFor="let year of years" [value]="year">{{ year }}</option>
  </select>
</div>

            <div class="col-12">
              <label for="educationDescription" class="form-label">Descripción</label>
              <textarea
                id="educationDescription"
                class="form-control"
                rows="3"
                formControlName="description"
              ></textarea>
              <div class="form-text text-light">
                Describe tus logros, proyectos o actividades destacadas.
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-end gap-2 mt-4">
            <button
              type="button"
              class="btn btn-outline-light"
              (click)="cancelEducationEdit()"
              [disabled]="educationSaving()"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="educationForm.invalid || educationSaving()"
            >
              <span
                *ngIf="educationSaving()"
                class="spinner-border spinner-border-sm me-2"
                role="status"
                aria-hidden="true"
              ></span>
              {{ educationSaving() ? 'Guardando...' : 'Guardar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</ng-container>
<ng-container *ngIf="experienceEditorOpen()">
  <div class="profile-editor" role="dialog" aria-modal="true" aria-labelledby="experienceEditorTitle">
    <div class="profile-editor__backdrop" (click)="cancelExperienceEdit()"></div>
    <div class="profile-editor__panel" (click)="$event.stopPropagation()">
      <div class="profile-editor__header d-flex justify-content-between align-items-start gap-3">
        <div>
          <h2 id="experienceEditorTitle" class="h5 mb-1 text-white">
            {{ editingExperienceId() ? 'Editar experiencia' : 'Agregar experiencia' }}
          </h2>
          <p class="mb-0 text-secondary">Comparte tu trayectoria profesional y proyectos destacados.</p>
        </div>
        <button
          type="button"
          class="btn-close btn-close-white"
          aria-label="Cerrar"
          (click)="cancelExperienceEdit()"
          [disabled]="experienceSaving()"
        ></button>
      </div>
      <div class="profile-editor__body">
        <div *ngIf="experienceSubmitError()" class="alert alert-danger" role="alert">
          {{ experienceSubmitError() }}
        </div>
        <form class="education-form" [formGroup]="experienceForm" (ngSubmit)="saveExperience()" novalidate>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="experienceTitle" class="form-label">Título o cargo</label>
              <input
                id="experienceTitle"
                type="text"
                class="form-control"
                formControlName="title"
                [class.is-invalid]="
                  experienceForm.controls.title.invalid &&
                  (experienceForm.controls.title.dirty || experienceForm.controls.title.touched)
                "
              />
              <div class="invalid-feedback">El título es obligatorio.</div>
            </div>
            <div class="col-md-6">
              <label for="experienceCompany" class="form-label">Empresa</label>
              <input id="experienceCompany" type="text" class="form-control" formControlName="company" />
            </div>
            <div class="col-md-6">
              <label for="experienceLocation" class="form-label">Ubicación</label>
              <input id="experienceLocation" type="text" class="form-control" formControlName="location" />
            </div>
            <div class="col-md-3">
              <label for="experienceStart" class="form-label">Año inicio</label>
              <select id="experienceStart" class="form-control" formControlName="startDate">
                <option value="">Selecciona un año</option>
                <option *ngFor="let year of years" [value]="year">{{ year }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="experienceEnd" class="form-label">Año fin</label>
              <select id="experienceEnd" class="form-control" formControlName="endDate">
                <option value="">Presente</option>
                <option *ngFor="let year of years" [value]="year">{{ year }}</option>
              </select>
            </div>
            <div class="col-12">
              <label for="experienceDescription" class="form-label">Descripción</label>
              <textarea
                id="experienceDescription"
                class="form-control"
                rows="3"
                formControlName="description"
              ></textarea>
              <div class="form-text text-light">Describe tus responsabilidades, logros o aprendizajes clave.</div>
            </div>
          </div>
          <div class="d-flex justify-content-end gap-2 mt-4">
            <button
              type="button"
              class="btn btn-outline-light"
              (click)="cancelExperienceEdit()"
              [disabled]="experienceSaving()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="experienceForm.invalid || experienceSaving()">
              <span
                *ngIf="experienceSaving()"
                class="spinner-border spinner-border-sm me-2"
                role="status"
                aria-hidden="true"
              ></span>
              {{ experienceSaving() ? 'Guardando...' : 'Guardar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</ng-container>

<ng-container *ngIf="skillsEditorOpen()">
  <div class="profile-editor" role="dialog" aria-modal="true" aria-labelledby="skillsEditorTitle">
    <div class="profile-editor__backdrop" (click)="cancelSkillEdit()"></div>
    <div class="profile-editor__panel" (click)="$event.stopPropagation()">
      <div class="profile-editor__header d-flex justify-content-between align-items-start gap-3">
        <div>
          <h2 id="skillsEditorTitle" class="h5 mb-1 text-white">
            {{ editingSkillId() ? 'Editar habilidad' : 'Agregar habilidad' }}
          </h2>
          <p class="mb-0 text-secondary">Comparte tus conocimientos y destaca tus fortalezas.</p>
        </div>
        <button
          type="button"
          class="btn-close btn-close-white"
          aria-label="Cerrar"
          (click)="cancelSkillEdit()"
          [disabled]="skillsSaving()"
        ></button>
      </div>
      <div class="profile-editor__body">
        <div *ngIf="skillsSubmitError()" class="alert alert-danger" role="alert">
          {{ skillsSubmitError() }}
        </div>
        <form class="skills-form" [formGroup]="skillForm" (ngSubmit)="saveSkill()" novalidate>
          <div class="row g-3">
            <div class="col-12">
              <label for="skillName" class="form-label">Habilidad</label>
              <select
                id="skillName"
                class="form-select"
                formControlName="skillId"
                [disabled]="skillCatalogLoading() || editingSkillId() !== null"
                [class.is-invalid]="
                  editingSkillId() === null && skillForm.controls.skillId.invalid &&
                  (skillForm.controls.skillId.dirty || skillForm.controls.skillId.touched)
                "
              >
                <option [ngValue]="null" disabled>
                  {{
                    skillCatalogLoading()
                      ? 'Cargando catálogo de habilidades...'
                      : 'Selecciona una habilidad'
                  }}
                </option>
                <ng-container *ngFor="let group of skillCatalogGroups()">
                  <optgroup [label]="group.category">
                    <option *ngFor="let item of group.items" [ngValue]="item.skillId">
                      {{ item.name }}
                    </option>
                  </optgroup>
                </ng-container>
              </select>
              <div class="invalid-feedback">La habilidad es obligatoria.</div>
              <div *ngIf="skillCatalogError(); else skillCatalogHint" class="form-text text-warning">
                {{ skillCatalogError() }}
              </div>
              <ng-template #skillCatalogHint>
                <div class="form-text text-light">
                  <ng-container *ngIf="skillCatalogLoading(); else skillCatalogReady">
                    Cargando catálogo de habilidades...
                  </ng-container>
                  <ng-template #skillCatalogReady>
                    <ng-container
                      *ngIf="skillCatalog().length > 0; else emptySkillCatalog"
                    >
                      Selecciona la habilidad tal como aparece en el catálogo.
                    </ng-container>
                    <ng-template #emptySkillCatalog>
                      <span class="text-warning">No hay habilidades disponibles en el catálogo.</span>
                    </ng-template>
                  </ng-template>
                </div>
              </ng-template>
            </div>
            <div class="col-sm-6">
              <label for="skillLevel" class="form-label">Nivel</label>
              <select id="skillLevel" class="form-select" formControlName="level">
                <option value="">Sin nivel</option>
                <option *ngFor="let level of [1, 2, 3, 4, 5]" [value]="level">{{ level }}</option>
              </select>
              <div class="form-text text-light">Valores del 1 (básico) al 5 (experto).</div>
            </div>
            <div class="col-sm-6">
              <label for="skillYears" class="form-label">Años de experiencia</label>
              <input
                id="skillYears"
                type="number"
                class="form-control"
                formControlName="yearsExperience"
                min="0"
                step="0.1"
                placeholder="Ej. 3.5"
              />
              <div class="form-text text-light">Puedes ingresar valores decimales para mayor precisión.</div>
            </div>
            <div class="col-sm-6">
              <label for="skillEndorsements" class="form-label">Respaldos</label>
              <input
                id="skillEndorsements"
                type="number"
                class="form-control"
                formControlName="endorsementCount"
                min="0"
                step="1"
                placeholder="0"
              />
              <div class="form-text text-light">Cantidad de recomendaciones recibidas en la plataforma.</div>
            </div>
          </div>
          <div class="d-flex justify-content-end gap-2 mt-4">
            <button
              type="button"
              class="btn btn-outline-light"
              (click)="cancelSkillEdit()"
              [disabled]="skillsSaving()"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="skillsSaving() || (editingSkillId() === null && skillForm.controls.skillId.invalid)"
            >
              <span
                *ngIf="skillsSaving()"
                class="spinner-border spinner-border-sm me-2"
                role="status"
                aria-hidden="true"
              ></span>
              {{ skillsSaving() ? 'Guardando...' : 'Guardar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</ng-container>

<div class="avatar-selector" *ngIf="avatarSelectorOpen()">
  <div class="avatar-selector__backdrop"></div>
  <div class="avatar-selector__dialog" role="dialog" aria-modal="true" aria-labelledby="avatarSelectorTitle">
    <div class="avatar-selector__header">
      <h5 id="avatarSelectorTitle" class="mb-0">Elige tu avatar InfoTex</h5>
      <button type="button" class="btn-close btn-close-white" aria-label="Cerrar" (click)="closeAvatarSelector()"></button>
    </div>
    <div class="avatar-selector__body">
      <div class="row g-3">
        <div class="col-6" *ngFor="let avatar of defaultAvatars">
          <button
            type="button"
            class="btn btn-outline-light w-100 avatar-option"
            [class.active]="isDefaultAvatarSelected(avatar.url)"
            (click)="selectDefaultAvatar(avatar.url)"
            [disabled]="profileForm.disabled"
          >
            <img
              [src]="avatar.url"
              [alt]="'Avatar predeterminado ' + avatar.label"
              class="img-fluid rounded mb-2"
            />
            <span>{{ avatar.label }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
