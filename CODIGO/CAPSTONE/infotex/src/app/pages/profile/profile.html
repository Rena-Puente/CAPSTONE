<div class="profile-page container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card bg-dark text-light border-secondary shadow">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="card-title h4 mb-0">Configura tu perfil</h2>
            <button type="button" class="btn btn-outline-light btn-sm" (click)="retry()" [disabled]="loading()">
              <span class="spinner-border spinner-border-sm me-2" role="status" *ngIf="loading()"></span>
              Actualizar
            </button>
          </div>

          <div *ngIf="loading()" class="text-center py-4">
            <div class="spinner-border text-light" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 mb-0">Obteniendo la información de tu perfil...</p>
          </div>

          <ng-container *ngIf="!loading()">
            <div *ngIf="loadError()" class="alert alert-danger" role="alert">
              {{ loadError() }}
            </div>

            <ng-container *ngIf="!loadError()">
              <div *ngIf="successMessage()" class="alert alert-success" role="alert">
                {{ successMessage() }}
              </div>

              <div *ngIf="submitError()" class="alert alert-danger" role="alert">
                {{ submitError() }}
              </div>

              <ng-container *ngIf="hasProfile(); else noProfile">
                <div *ngIf="isComplete(); else incompleteAlert" class="alert alert-success" role="alert">
                  ¡Tu perfil está completo! Excelente trabajo.
                </div>

                <ng-template #incompleteAlert>
                  <div class="alert alert-warning" role="alert">
                    Tu perfil aún no está completo. Completa los siguientes elementos para finalizarlo:
                    <ul class="mb-0 mt-2">
                      <li *ngFor="let item of missingFields()">{{ item }}</li>
                    </ul>
                  </div>
                </ng-template>
              </ng-container>

              <form class="profile-form" [formGroup]="profileForm" (ngSubmit)="save()" novalidate>
                <div class="mb-3">
                  <label for="profileDisplayName" class="form-label">Nombre para mostrar</label>
                  <input
                    id="profileDisplayName"
                    type="text"
                    class="form-control"
                    formControlName="displayName"
                    [class.is-invalid]="
                      (displayNameControl.invalid && (displayNameControl.dirty || displayNameControl.touched)) ||
                      fieldState().displayName.ok === false
                    "
                  />
                  <div class="invalid-feedback" *ngIf="displayNameControl.hasError('required') && (displayNameControl.dirty || displayNameControl.touched)">
                    El nombre para mostrar es obligatorio.
                  </div>
                  <div class="invalid-feedback" *ngIf="fieldState().displayName.ok === false">
                    {{ fieldState().displayName.error || 'El servidor reportó un problema con este campo.' }}
                  </div>
                </div>

                <div class="mb-3">
                  <label for="profileHeadline" class="form-label">Titular profesional</label>
                  <input
                    id="profileHeadline"
                    type="text"
                    class="form-control"
                    formControlName="headline"
                    [class.is-invalid]="
                      (headlineControl.invalid && (headlineControl.dirty || headlineControl.touched)) ||
                      fieldState().headline.ok === false
                    "
                  />
                  <div class="invalid-feedback" *ngIf="headlineControl.hasError('required') && (headlineControl.dirty || headlineControl.touched)">
                    El titular profesional es obligatorio.
                  </div>
                  <div class="invalid-feedback" *ngIf="fieldState().headline.ok === false">
                    {{ fieldState().headline.error || 'El servidor reportó un problema con este campo.' }}
                  </div>
                </div>

                <div class="mb-3">
                  <label for="profileBiography" class="form-label">Biografía</label>
                  <textarea
                    id="profileBiography"
                    class="form-control"
                    formControlName="biography"
                    rows="4"
                    [class.is-invalid]="
                      (biographyControl.invalid && (biographyControl.dirty || biographyControl.touched)) ||
                      fieldState().biography.ok === false
                    "
                  ></textarea>
                  <div class="form-text text-light">Escribe al menos 80 caracteres sobre ti.</div>
                  <div class="invalid-feedback" *ngIf="biographyControl.hasError('required') && (biographyControl.dirty || biographyControl.touched)">
                    La biografía es obligatoria.
                  </div>
                  <div class="invalid-feedback" *ngIf="biographyControl.hasError('minTrimmedLength') && (biographyControl.dirty || biographyControl.touched)">
                    La biografía debe contener al menos 80 caracteres.
                  </div>
                  <div class="invalid-feedback" *ngIf="fieldState().biography.ok === false">
                    {{ fieldState().biography.error || 'El servidor reportó un problema con este campo.' }}
                  </div>
                </div>

                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="profileCountry" class="form-label">País</label>
                    <input
                      id="profileCountry"
                      type="text"
                      class="form-control"
                      formControlName="country"
                      [class.is-invalid]="
                        (countryControl.invalid && (countryControl.dirty || countryControl.touched)) ||
                        fieldState().country.ok === false
                      "
                    />
                    <div class="invalid-feedback" *ngIf="countryControl.hasError('required') && (countryControl.dirty || countryControl.touched)">
                      El país es obligatorio.
                    </div>
                    <div class="invalid-feedback" *ngIf="fieldState().country.ok === false">
                      {{ fieldState().country.error || 'El servidor reportó un problema con este campo.' }}
                    </div>
                  </div>

                  <div class="col-md-6">
                    <label for="profileCity" class="form-label">Ciudad</label>
                    <input
                      id="profileCity"
                      type="text"
                      class="form-control"
                      formControlName="city"
                      [class.is-invalid]="
                        (cityControl.invalid && (cityControl.dirty || cityControl.touched)) ||
                        fieldState().city.ok === false
                      "
                    />
                    <div class="invalid-feedback" *ngIf="cityControl.hasError('required') && (cityControl.dirty || cityControl.touched)">
                      La ciudad es obligatoria.
                    </div>
                    <div class="invalid-feedback" *ngIf="fieldState().city.ok === false">
                      {{ fieldState().city.error || 'El servidor reportó un problema con este campo.' }}
                    </div>
                  </div>
                </div>

                <div class="mb-4 mt-3">
                  <label for="profileAvatarUrl" class="form-label">URL de la foto de perfil</label>
                  <input
                    id="profileAvatarUrl"
                    type="url"
                    class="form-control"
                    formControlName="avatarUrl"
                    [class.is-invalid]="
                      (avatarUrlControl.invalid && (avatarUrlControl.dirty || avatarUrlControl.touched)) ||
                      fieldState().avatarUrl.ok === false
                    "
                  />
                  <div class="invalid-feedback" *ngIf="avatarUrlControl.hasError('required') && (avatarUrlControl.dirty || avatarUrlControl.touched)">
                    La URL de la foto de perfil es obligatoria.
                  </div>
                  <div class="invalid-feedback" *ngIf="fieldState().avatarUrl.ok === false">
                    {{ fieldState().avatarUrl.error || 'El servidor reportó un problema con este campo.' }}
                  </div>
                </div>

                <div class="d-flex justify-content-end">
                  <button type="submit" class="btn btn-primary" [disabled]="profileForm.invalid || profileForm.disabled || saving()">
                    <span class="spinner-border spinner-border-sm me-2" role="status" *ngIf="saving()"></span>
                    Guardar cambios
                  </button>
                </div>
              </form>
            </ng-container>

            <ng-template #noProfile>
              <div class="alert alert-info" role="alert">
                Aún no has completado la información básica de tu perfil. Utiliza el formulario para registrar tus datos y completar tu perfil.
              </div>
            </ng-template>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>