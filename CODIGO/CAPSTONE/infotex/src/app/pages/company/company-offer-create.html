<section class="company-offer-create">
  <header class="company-offer-create__header">
    <h2 class="company-offer-create__title">Crear nueva oferta laboral</h2>
    <p class="company-offer-create__subtitle">
      Comparte una vacante detallada para atraer al mejor talento.
    </p>
  </header>

  <form [formGroup]="form" (ngSubmit)="submit()" novalidate class="company-offer-create__form">
    <div class="company-offer-create__field">
      <label for="offerTitle" class="company-offer-create__label">Título</label>
      <input
        type="text"
        id="offerTitle"
        class="company-offer-create__control"
        formControlName="title"
        [class.is-invalid]="shouldShowError('title')"
        placeholder="Ej. Diseñador UX Senior"
      />
      <div class="company-offer-create__error" *ngIf="getControlError('title')">
        {{ getControlError('title') }}
      </div>
    </div>

    <div class="company-offer-create__field">
      <label for="offerDescription" class="company-offer-create__label">Descripción</label>
      <textarea
        id="offerDescription"
        class="company-offer-create__control company-offer-create__control--textarea"
        rows="6"
        formControlName="description"
        [class.is-invalid]="shouldShowError('description')"
        placeholder="Detalla responsabilidades, beneficios y requisitos esenciales"
      ></textarea>
      <div class="company-offer-create__error" *ngIf="getControlError('description')">
        {{ getControlError('description') }}
      </div>
    </div>

    <div class="company-offer-create__grid">
      <div class="company-offer-create__field">
        <label for="offerLocationType" class="company-offer-create__label">Modalidad</label>
        <select
          id="offerLocationType"
          class="company-offer-create__control"
          [class.is-invalid]="shouldShowError('locationType')"
          [value]="locationTypeSelection()"
          (change)="handleLocationTypeSelectionChange($any($event.target).value)"
          [disabled]="isSubmitting()"
          aria-label="Selecciona la modalidad de trabajo"
        >
          <option value="" disabled [selected]="!locationTypeSelection()">
            Selecciona una modalidad
          </option>
          <option *ngFor="let option of locationTypeOptions; trackBy: trackByValue" [value]="option">
            {{ option }}
          </option>
          <option [value]="customLocationTypeFlag">Otra (especificar)</option>
        </select>
        <input
          *ngIf="shouldShowCustomLocationTypeInput()"
          type="text"
          class="company-offer-create__control company-offer-create__control--stacked"
          [class.is-invalid]="shouldShowError('locationType')"
          [value]="customLocationTypeValue()"
          (input)="handleCustomLocationTypeInput($any($event.target).value)"
          (blur)="form.controls.locationType.markAsTouched()"
          placeholder="Especifica la modalidad"
          [disabled]="isSubmitting()"
        />
        <div class="company-offer-create__error" *ngIf="getControlError('locationType')">
          {{ getControlError('locationType') }}
        </div>
      </div>

      <div class="company-offer-create__field">
        <label for="offerCity" class="company-offer-create__label">Ciudad</label>
        <select
          id="offerCity"
          class="company-offer-create__control"
          formControlName="city"
          [class.is-invalid]="shouldShowError('city')"
          [disabled]="citiesLoading() || isSubmitting() || !!citiesError() || cityOptions().length === 0"
          aria-label="Selecciona la ciudad de la oferta"
        >
          <option value="" disabled [selected]="!form.controls.city.value">Selecciona una ciudad</option>
          <option *ngFor="let city of cityOptions(); trackBy: trackByValue" [value]="city">{{ city }}</option>
        </select>
        <div class="company-offer-create__hint" *ngIf="citiesLoading()">Cargando ciudades...</div>
        <div class="company-offer-create__error" *ngIf="citiesError()">{{ citiesError() }}</div>
        <div class="company-offer-create__error" *ngIf="getControlError('city')">
          {{ getControlError('city') }}
        </div>
      </div>

      <div class="company-offer-create__field">
        <label for="offerCountry" class="company-offer-create__label">País</label>
        <select
          id="offerCountry"
          class="company-offer-create__control"
          formControlName="country"
          [class.is-invalid]="shouldShowError('country')"
          [disabled]="isSubmitting()"
          aria-label="Selecciona el país de la oferta"
        >
          <option value="" disabled [selected]="!form.controls.country.value">Selecciona un país</option>
          <option *ngFor="let country of countryOptions; trackBy: trackByValue" [value]="country">
            {{ country }}
          </option>
        </select>
        <div class="company-offer-create__error" *ngIf="getControlError('country')">
          {{ getControlError('country') }}
        </div>
      </div>

      <div class="company-offer-create__field">
        <label for="offerSeniority" class="company-offer-create__label">Carrera</label>
        <select
          id="offerSeniority"
          class="company-offer-create__control"
          formControlName="seniority"
          [class.is-invalid]="shouldShowError('seniority')"
          [disabled]="seniorityLoading() || isSubmitting() || !!seniorityError() || !hasSeniorityOptions()"
          aria-label="Selecciona la carrera asociada a la oferta"
        >
          <option value="" disabled [selected]="!form.controls.seniority.value">
            {{ seniorityLoading() ? 'Cargando carreras disponibles...' : 'Selecciona una carrera' }}
          </option>
          <ng-container *ngFor="let group of seniorityOptionGroups(); trackBy: trackSeniorityCategory">
            <optgroup [label]="group.name">
              <option
                *ngFor="let option of group.options; trackBy: trackSeniorityOption"
                [value]="option"
              >
                {{ option }}
              </option>
            </optgroup>
          </ng-container>
        </select>
        <div class="company-offer-create__hint" *ngIf="seniorityLoading()">Cargando carreras...</div>
        <div class="company-offer-create__error" *ngIf="seniorityError()">{{ seniorityError() }}</div>
        <div class="company-offer-create__error" *ngIf="getControlError('seniority')">
          {{ getControlError('seniority') }}
        </div>
      </div>

      <div class="company-offer-create__field">
        <label for="offerContractType" class="company-offer-create__label">Tipo de contrato</label>
        <select
          id="offerContractType"
          class="company-offer-create__control"
          formControlName="contractType"
          [class.is-invalid]="shouldShowError('contractType')"
          [disabled]="isSubmitting()"
          aria-label="Selecciona el tipo de contrato"
        >
          <option value="" disabled [selected]="!form.controls.contractType.value">Selecciona un tipo</option>
          <option *ngFor="let option of contractTypeOptions; trackBy: trackByValue" [value]="option">
            {{ option }}
          </option>
        </select>
        <div class="company-offer-create__error" *ngIf="getControlError('contractType')">
          {{ getControlError('contractType') }}
        </div>
      </div>
    </div>

    <div class="company-offer-create__questions" formArrayName="questions">
      <div class="company-offer-create__questions-header">
        <div>
          <h3 class="company-offer-create__questions-title">Preguntas para postulantes</h3>
          <p class="company-offer-create__questions-subtitle">
            Puedes agregar hasta tres preguntas para conocer mejor a cada candidato.
          </p>
        </div>
        <button
          type="button"
          class="company-offer-create__add-question"
          (click)="addQuestion()"
          [disabled]="!canAddQuestion() || isSubmitting()"
        >
          Agregar pregunta
        </button>
      </div>

      <div class="company-offer-create__question-list" *ngIf="questionControls.length > 0; else emptyQuestions">
        <div
          class="company-offer-create__question-item"
          *ngFor="let question of questionControls; let i = index; trackBy: trackQuestion"
          [formGroupName]="i"
        >
          <div class="company-offer-create__field">
            <label class="company-offer-create__label" [for]="'offerQuestion' + i">
              Pregunta {{ i + 1 }}
            </label>
            <input
              type="text"
              class="company-offer-create__control"
              [id]="'offerQuestion' + i"
              formControlName="text"
              placeholder="Ej. ¿Cuál ha sido tu mayor desafío profesional?"
              [class.is-invalid]="question.controls.text.invalid && (question.controls.text.dirty || question.controls.text.touched || submitAttempted())"
              [disabled]="isSubmitting()"
            />
            <div class="company-offer-create__error" *ngIf="getQuestionError(question)">
              {{ getQuestionError(question) }}
            </div>
          </div>

          <div class="company-offer-create__question-actions">
            <label class="company-offer-create__checkbox">
              <input type="checkbox" formControlName="required" [disabled]="isSubmitting()" />
              Pregunta obligatoria
            </label>
            <button
              type="button"
              class="company-offer-create__question-remove"
              (click)="removeQuestion(i)"
              [disabled]="isSubmitting()"
            >
              Quitar
            </button>
          </div>
        </div>
      </div>

      <ng-template #emptyQuestions>
        <p class="company-offer-create__questions-empty">
          Agrega preguntas opcionales para conocer mejor a las personas postulantes.
        </p>
      </ng-template>
    </div>

    <div class="company-offer-create__actions">
      <button type="submit" class="company-offer-create__submit" [disabled]="isSubmitting()">
        <span class="company-offer-create__spinner" *ngIf="isSubmitting()" role="status" aria-hidden="true"></span>
        Publicar oferta
      </button>

      <span class="company-offer-create__feedback company-offer-create__feedback--success" *ngIf="submitSuccess()">
        La oferta se creó correctamente.
      </span>
      <span class="company-offer-create__feedback company-offer-create__feedback--error" *ngIf="submitError()">
        {{ submitError() }}
      </span>
    </div>
  </form>
</section>
