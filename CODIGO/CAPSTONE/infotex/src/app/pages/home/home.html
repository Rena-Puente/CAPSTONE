<div class="home-page">
  <div class="container py-4">
    <section class="home-header card shadow-sm border-0 mb-4">
      <div class="card-body">
        <h1 class="display-6 fw-semibold text-light mb-2">Oportunidades disponibles</h1>
        <p class="lead text-light mb-0">
          Explora las ofertas publicadas por empresas de la comunidad y postula con un solo clic.
        </p>
      </div>
    </section>

    <div *ngIf="globalMessage()" class="alert alert-success border-0 shadow-sm" role="alert">
      {{ globalMessage() }}
    </div>

    <div *ngIf="biographyError()" class="alert alert-danger border-0 shadow-sm" role="alert">
      {{ biographyError() }}
    </div>

    <div
      *ngIf="!biographyLoading() && !biographyError() && missingBiography()"
      class="alert alert-warning border-0 shadow-sm"
      role="alert"
    >
      <div class="d-flex flex-column flex-md-row gap-3 justify-content-between align-items-md-center">
        <span>Completa tu biografía en tu perfil para usarla como carta de presentación al postular.</span>
        <button
          type="button"
          class="btn btn-outline-dark btn-sm fw-semibold"
          (click)="openProfileEditor()"
          aria-label="Abrir el editor de perfil"
        >
          Editar perfil
        </button>
      </div>
    </div>

    <div *ngIf="loading()" class="alert alert-info border-0 shadow-sm" role="status">
      Cargando ofertas disponibles...
    </div>

    <ng-container *ngIf="!loading()">
      <div *ngIf="error()" class="alert alert-danger border-0 shadow-sm" role="alert">
        {{ error() }}
      </div>

      <section *ngIf="!error() && offers().length > 0" class="filter-toolbar card shadow-sm border-0 mb-4">
        <div class="filter-toolbar__header">
          <div>
            <p class="filter-toolbar__count mb-1">
              Mostrando
              <strong>{{ filteredOffers().length }}</strong>
              de
              <strong>{{ offers().length }}</strong>
              ofertas disponibles.
            </p>
            <p class="filter-toolbar__hint mb-0">
              Combina los filtros para centrarte en la categoría, modalidad y región que prefieras.
            </p>
          </div>
          <button
            type="button"
            class="filter-toolbar__clear"
            *ngIf="activeFiltersCount() > 0"
            (click)="clearFilters()"
          >
            Limpiar filtros ({{ activeFiltersCount() }})
          </button>
        </div>

        <div class="filter-toolbar__controls">
          <div class="filter-dropdown" [class.filter-dropdown--open]="isFilterOpen('career')">
            <button
              type="button"
              class="filter-dropdown__trigger"
              (click)="toggleFilterDropdown('career')"
              [attr.aria-expanded]="isFilterOpen('career')"
              [attr.aria-controls]="filterMenuIds.career"
            >
              Categoría de carrera
              <span *ngIf="selectedCareerCategories().size > 0" class="filter-dropdown__counter">
                {{ selectedCareerCategories().size }}
              </span>
              <span class="filter-dropdown__caret" aria-hidden="true"></span>
            </button>
            <div class="filter-dropdown__menu" *ngIf="isFilterOpen('career')" [attr.id]="filterMenuIds.career">
              <p class="filter-dropdown__description">
                Selecciona una o más categorías para priorizar las áreas que más te interesan.
              </p>
              <div class="filter-dropdown__options">
                <label class="filter-checkbox" *ngFor="let category of careerCategoryOptions(); trackBy: trackByLabel">
                  <input type="checkbox" [checked]="isCategorySelected(category)" (change)="toggleCategory(category)" />
                  <span>{{ category }}</span>
                </label>
                <div class="filter-dropdown__empty" *ngIf="careerCategoryOptions().length === 0">
                  Aún no hay categorías asociadas a las ofertas publicadas.
                </div>
              </div>
            </div>
          </div>

          <div class="filter-dropdown" [class.filter-dropdown--open]="isFilterOpen('modality')">
            <button
              type="button"
              class="filter-dropdown__trigger"
              (click)="toggleFilterDropdown('modality')"
              [attr.aria-expanded]="isFilterOpen('modality')"
              [attr.aria-controls]="filterMenuIds.modality"
            >
              Modalidad
              <span *ngIf="selectedModalities().size > 0" class="filter-dropdown__counter">
                {{ selectedModalities().size }}
              </span>
              <span class="filter-dropdown__caret" aria-hidden="true"></span>
            </button>
            <div class="filter-dropdown__menu" *ngIf="isFilterOpen('modality')" [attr.id]="filterMenuIds.modality">
              <p class="filter-dropdown__description">
                Define cómo quieres trabajar: remoto, híbrido, presencial u otras variantes.
              </p>
              <div class="filter-dropdown__options">
                <label
                  class="filter-checkbox filter-checkbox--stacked"
                  *ngFor="let option of modalityOptions; trackBy: trackByModality"
                >
                  <input type="checkbox" [checked]="isModalitySelected(option.id)" (change)="toggleModality(option.id)" />
                  <span>
                    <strong>{{ option.label }}</strong>
                    <small>{{ option.description }}</small>
                  </span>
                </label>
              </div>
            </div>
          </div>

          <div class="filter-dropdown" [class.filter-dropdown--open]="isFilterOpen('region')">
            <button
              type="button"
              class="filter-dropdown__trigger"
              (click)="toggleFilterDropdown('region')"
              [attr.aria-expanded]="isFilterOpen('region')"
              [attr.aria-controls]="filterMenuIds.region"
            >
              Región
              <span *ngIf="selectedRegions().size > 0" class="filter-dropdown__counter">
                {{ selectedRegions().size }}
              </span>
              <span class="filter-dropdown__caret" aria-hidden="true"></span>
            </button>
            <div class="filter-dropdown__menu" *ngIf="isFilterOpen('region')" [attr.id]="filterMenuIds.region">
              <p class="filter-dropdown__description">
                Elige la region de tu preferencia para buscar empleo.
              </p>
              <div class="filter-dropdown__options">
                <label class="filter-checkbox" *ngFor="let region of regionOptions; trackBy: trackByLabel">
                  <input type="checkbox" [checked]="isRegionSelected(region)" (change)="toggleRegion(region)" />
                  <span>{{ region }}</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div *ngIf="!error() && offers().length === 0" class="alert alert-secondary border-0 shadow-sm">
        Aún no hay ofertas disponibles. Vuelve más tarde para descubrir nuevas oportunidades.
      </div>

      <div
        *ngIf="!error() && offers().length > 0 && filteredOffers().length === 0"
        class="alert alert-secondary border-0 shadow-sm"
      >
        No encontramos ofertas que coincidan con los filtros seleccionados.
        <button type="button" class="btn btn-link text-decoration-none ps-1" (click)="clearFilters()">
          Limpiar filtros
        </button>
      </div>

      <div *ngIf="!error() && filteredOffers().length > 0" class="offer-list">
        <article class="offer-card" *ngFor="let offer of filteredOffers(); trackBy: trackByOfferId">
          <div class="offer-logo" [ngClass]="{ 'with-image': !!getCompanyLogoUrl(offer) }">
            <ng-container *ngIf="getCompanyLogoUrl(offer) as logo; else initials">
              <img [src]="logo" [alt]="getCompanyDisplayName(offer)" loading="lazy" />
            </ng-container>
            <ng-template #initials>
              <span>{{ getCompanyInitials(offer) }}</span>
            </ng-template>
          </div>

          <div class="offer-content">
            <div class="offer-header">
              <h2 class="offer-company">{{ offer.title || 'Oferta sin título' }}</h2>
              <p class="text-light mb-1">
                {{ getCompanyDisplayName(offer) }}
                <span class="text-info">•</span>
                <span class="text-light">
                  {{ offer.city || offer.country || offer.company.city || offer.company.country || 'Ubicación no especificada' }}
                </span>
              </p>
              <p class="offer-meta mb-0">
                <span *ngIf="offer.contractType" class="meta-tag">{{ offer.contractType }}</span>
                <span *ngIf="offer.locationType" class="meta-tag">{{ offer.locationType }}</span>
                <span *ngIf="offer.seniority" class="meta-tag">{{ offer.seniority }}</span>
                <span *ngIf="offer.createdAt" class="meta-tag text-secondary">
                  Publicada {{ offer.createdAt | date: 'mediumDate' }}
                </span>
              </p>
            </div>

            <p class="offer-description">
              {{ offer.description || 'La empresa no proporcionó una descripción detallada para esta oferta.' }}
            </p>

            <div class="offer-application-form">
              <div class="offer-questions-preview" *ngIf="offer.questions?.length">
                <p class="offer-questions-preview__title mb-1">Preguntas rápidas</p>
                <p class="offer-questions-preview__hint">
                  Esta oferta incluye {{ offer.questions?.length ?? 0 }} preguntas cortas que responderás al
                  momento de postular.
                </p>
              </div>

              <div class="offer-actions">
                <button
                  type="button"
                  class="btn btn-apply"
                  [disabled]="isApplying(offer.id) || isApplied(offer.id) || missingBiography()"
                  (click)="handleApplyClick(offer)"
                >
                  <span
                    *ngIf="isApplying(offer.id)"
                    class="spinner-border spinner-border-sm me-2"
                    role="status"
                  ></span>
                  <ng-container *ngIf="isApplied(offer.id); else applyLabel">
                    <span class="me-2"><i class="bi bi-check-square"></i></span>
                    Ya postulaste
                  </ng-container>
                  <ng-template #applyLabel>Postular</ng-template>
                </button>

                <span *ngIf="getApplicationError(offer.id)" class="text-danger small ms-3">
                  {{ getApplicationError(offer.id) }}
                </span>
              </div>
            </div>
          </div>
        </article>
      </div>
    </ng-container>
  </div>

  <div class="application-overlay" *ngIf="activeApplicationOffer() as currentOffer">
    <div class="application-overlay__backdrop" (click)="closeApplicationOverlay()"></div>
    <div
      class="application-overlay__dialog"
      role="dialog"
      aria-modal="true"
      [attr.aria-labelledby]="'application-overlay-title-' + currentOffer.id"
    >
      <form (submit)="submitOverlayApplication($event, currentOffer)" novalidate>
        <header class="application-overlay__header">
          <div>
            <p class="application-overlay__eyebrow mb-1">Postular a</p>
            <h2 class="application-overlay__title" [attr.id]="'application-overlay-title-' + currentOffer.id">
              {{ currentOffer.title || 'Oferta sin título' }}
            </h2>
            <p class="application-overlay__subtitle mb-0">
              {{ getCompanyDisplayName(currentOffer) }}
            </p>
          </div>
          <button type="button" class="application-overlay__close" (click)="closeApplicationOverlay()">
            <span aria-hidden="true">&times;</span>
            <span class="visually-hidden">Cerrar</span>
          </button>
        </header>

        <div class="application-overlay__body">
          <p class="application-overlay__hint">
            Responde las preguntas para completar tu postulación. Puedes usar tu biografía como carta de
            presentación.
          </p>

          <div class="offer-questions" *ngIf="currentOffer.questions?.length; else noQuestions">
            <div
              class="offer-question"
              *ngFor="let question of currentOffer.questions; let i = index; trackBy: trackByQuestionIndex"
            >
              <label class="form-label" [attr.for]="'overlay-question-' + currentOffer.id + '-' + i">
                {{ question.text }}
                <span *ngIf="question.required" class="text-danger" aria-hidden="true">*</span>
              </label>
              <textarea
                class="form-control"
                rows="3"
                [attr.id]="'overlay-question-' + currentOffer.id + '-' + i"
                [value]="getAnswerValue(currentOffer.id, i)"
                (input)="handleAnswerInput(currentOffer, i, $any($event.target).value)"
                [attr.aria-required]="question.required"
              ></textarea>
              <div class="text-danger small mt-1" *ngIf="question.required && hasAnswerError(currentOffer.id, i)">
                Esta pregunta es obligatoria.
              </div>
            </div>
          </div>

          <ng-template #noQuestions>
            <p class="application-overlay__hint mb-0">
              Esta oferta no requiere preguntas adicionales. Haz clic en "Enviar postulación" para
              confirmar.
            </p>
          </ng-template>
        </div>

        <div class="application-overlay__footer">
          <span *ngIf="getApplicationError(currentOffer.id)" class="text-danger small">
            {{ getApplicationError(currentOffer.id) }}
          </span>
          <div class="application-overlay__actions">
            <button type="button" class="btn btn-outline-light" (click)="closeApplicationOverlay()">
              Cancelar
            </button>
            <button
              type="submit"
              class="btn btn-apply"
              [disabled]="isApplying(currentOffer.id) || isApplied(currentOffer.id)"
            >
              <span
                *ngIf="isApplying(currentOffer.id)"
                class="spinner-border spinner-border-sm me-2"
                role="status"
              ></span>
              <ng-container *ngIf="isApplied(currentOffer.id); else submitLabel">
                <span class="me-2"><i class="bi bi-check-square"></i></span>
                Ya postulaste
              </ng-container>
              <ng-template #submitLabel>Enviar postulación</ng-template>
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
